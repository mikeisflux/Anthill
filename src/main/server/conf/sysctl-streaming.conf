# Ant Media Server - OS-Level Network Tuning for Ultra-Low Latency Streaming
# Copy to /etc/sysctl.d/99-antmedia-streaming.conf
# Apply with: sudo sysctl -p /etc/sysctl.d/99-antmedia-streaming.conf

# ============================================
# NETWORK BUFFER SIZES
# ============================================
# Maximum socket receive buffer (26MB)
net.core.rmem_max = 26214400

# Maximum socket send buffer (26MB)
net.core.wmem_max = 26214400

# Default socket receive buffer
net.core.rmem_default = 1048576

# Default socket send buffer
net.core.wmem_default = 1048576

# ============================================
# TCP BUFFER TUNING
# ============================================
# TCP receive buffer: min, default, max (in bytes)
net.ipv4.tcp_rmem = 4096 1048576 26214400

# TCP send buffer: min, default, max (in bytes)
net.ipv4.tcp_wmem = 4096 1048576 26214400

# ============================================
# UDP BUFFER TUNING (Critical for WebRTC)
# ============================================
# UDP receive buffer: min, pressure, max
net.ipv4.udp_rmem_min = 8192

# UDP memory: min, pressure, max (pages)
net.ipv4.udp_mem = 65536 131072 262144

# ============================================
# LOW LATENCY TCP FLAGS
# ============================================
# Enable TCP low latency mode
net.ipv4.tcp_low_latency = 1

# Enable TCP Fast Open (client and server)
net.ipv4.tcp_fastopen = 3

# Disable TCP slow start after idle
net.ipv4.tcp_slow_start_after_idle = 0

# ============================================
# CONNECTION HANDLING
# ============================================
# Increase connection backlog
net.core.somaxconn = 65535

# Increase network device backlog
net.core.netdev_max_backlog = 65535

# Maximum number of connection tracking entries
net.netfilter.nf_conntrack_max = 1048576

# ============================================
# TCP KEEPALIVE SETTINGS
# ============================================
# Time before sending keepalive probes (seconds)
net.ipv4.tcp_keepalive_time = 60

# Interval between keepalive probes (seconds)
net.ipv4.tcp_keepalive_intvl = 10

# Number of keepalive probes before dropping connection
net.ipv4.tcp_keepalive_probes = 6

# ============================================
# TCP TIMEOUT TUNING
# ============================================
# FIN timeout (reduce from default 60s)
net.ipv4.tcp_fin_timeout = 15

# TIME_WAIT reuse (for high connection rate)
net.ipv4.tcp_tw_reuse = 1

# ============================================
# TCP CONGESTION CONTROL
# ============================================
# Use BBR congestion control (recommended for streaming)
# Requires kernel 4.9+ with BBR module
# net.core.default_qdisc = fq
# net.ipv4.tcp_congestion_control = bbr

# Alternative: use cubic (default, good for most cases)
net.ipv4.tcp_congestion_control = cubic

# ============================================
# IP FRAGMENTATION
# ============================================
# Memory for reassembly (low, high thresholds)
net.ipv4.ipfrag_low_thresh = 3145728
net.ipv4.ipfrag_high_thresh = 4194304

# Fragmentation timeout
net.ipv4.ipfrag_time = 30

# ============================================
# FILE DESCRIPTORS
# ============================================
# Maximum number of open files (system-wide)
fs.file-max = 2097152

# Maximum number of inotify watches
fs.inotify.max_user_watches = 524288

# ============================================
# VIRTUAL MEMORY
# ============================================
# Reduce swappiness for better performance
vm.swappiness = 10

# Overcommit memory mode
vm.overcommit_memory = 1

# Dirty page writeback settings
vm.dirty_ratio = 40
vm.dirty_background_ratio = 10

# ============================================
# SECURITY (Optional - Enable if needed)
# ============================================
# Enable SYN cookies (DoS protection)
net.ipv4.tcp_syncookies = 1

# Ignore ICMP broadcasts
net.ipv4.icmp_echo_ignore_broadcasts = 1

# ============================================
# IPv6 SETTINGS (if using IPv6)
# ============================================
# net.ipv6.conf.all.disable_ipv6 = 0
# net.ipv6.conf.default.disable_ipv6 = 0
